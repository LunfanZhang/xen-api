diff --git a/ocaml/xapi-idl/storage/storage_interface.ml b/ocaml/xapi-idl/storage/storage_interface.ml
index eaabacc9e..0931c8a8f 100644
--- a/ocaml/xapi-idl/storage/storage_interface.ml
+++ b/ocaml/xapi-idl/storage/storage_interface.ml
@@ -975,6 +975,23 @@ module StorageAPI (R : RPC) = struct
       declare "VDI.set_content_id" []
         (dbg_p @-> sr_p @-> vdi_p @-> content_id_p @-> returning unit_p err)
 
+    (** [set_snapshot_metadata sr vdi snapshot_of snapshot_time is_a_snapshot] updates
+        the snapshot metadata fields in the storage backend. Used after migration to ensure
+        storage backend metadata matches XAPI database. *)
+    let set_snapshot_metadata =
+      let snapshot_of_p = Param.mk ~name:"snapshot_of" Vdi.t in
+      let snapshot_time_p = Param.mk ~name:"snapshot_time" Types.string in
+      let is_a_snapshot_p = Param.mk ~name:"is_a_snapshot" Types.bool in
+      declare "VDI.set_snapshot_metadata" []
+        (dbg_p
+        @-> sr_p
+        @-> vdi_p
+        @-> snapshot_of_p
+        @-> snapshot_time_p
+        @-> is_a_snapshot_p
+        @-> returning unit_p err
+        )
+
     (** [compose task sr parent child] layers the updates from [child] onto [parent],
         modifying [child] *)
     let compose =
@@ -1612,6 +1629,16 @@ module type Server_impl = sig
       -> content_id:content_id
       -> unit
 
+    val set_snapshot_metadata :
+         context
+      -> dbg:debug_info
+      -> sr:sr
+      -> vdi:vdi
+      -> snapshot_of:vdi
+      -> snapshot_time:string
+      -> is_a_snapshot:bool
+      -> unit
+
     val compose :
       context -> dbg:debug_info -> sr:sr -> vdi1:vdi -> vdi2:vdi -> unit
 
@@ -1824,6 +1851,9 @@ module Server (Impl : Server_impl) () = struct
     S.VDI.set_content_id (fun dbg sr vdi content_id ->
         Impl.VDI.set_content_id () ~dbg ~sr ~vdi ~content_id
     ) ;
+    S.VDI.set_snapshot_metadata (fun dbg sr vdi snapshot_of snapshot_time is_a_snapshot ->
+        Impl.VDI.set_snapshot_metadata () ~dbg ~sr ~vdi ~snapshot_of ~snapshot_time ~is_a_snapshot
+    ) ;
     S.VDI.compose (fun dbg sr vdi1 vdi2 ->
         Impl.VDI.compose () ~dbg ~sr ~vdi1 ~vdi2
     ) ;
diff --git a/ocaml/xapi-idl/storage/storage_skeleton.ml b/ocaml/xapi-idl/storage/storage_skeleton.ml
index a2d2d04ab..e0c1cf037 100644
--- a/ocaml/xapi-idl/storage/storage_skeleton.ml
+++ b/ocaml/xapi-idl/storage/storage_skeleton.ml
@@ -155,6 +155,9 @@ module VDI = struct
   let set_content_id ctx ~dbg ~sr ~vdi ~content_id =
     Storage_interface.unimplemented __FUNCTION__
 
+  let set_snapshot_metadata ctx ~dbg ~sr ~vdi ~snapshot_of ~snapshot_time ~is_a_snapshot =
+    Storage_interface.unimplemented __FUNCTION__
+
   let compose ctx ~dbg ~sr ~vdi1 ~vdi2 =
     Storage_interface.unimplemented __FUNCTION__
 
diff --git a/ocaml/xapi-storage-script/main.ml b/ocaml/xapi-storage-script/main.ml
index 1eccd3867..526e661d8 100644
--- a/ocaml/xapi-storage-script/main.ml
+++ b/ocaml/xapi-storage-script/main.ml
@@ -1346,6 +1346,15 @@ module VDIImpl (M : META) = struct
         Volume_client.unset (volume_rpc ~dbg ?missing) dbg sr vdi key
     )
 
+  let set_snapshot_metadata ~dbg ~sr ~vdi ~snapshot_of ~snapshot_time ~is_a_snapshot =
+    let vdi_str = Storage_interface.Vdi.string_of vdi in
+    let snapshot_of_str = Storage_interface.Vdi.string_of snapshot_of in
+    set ~dbg ~sr ~vdi:vdi_str ~key:_snapshot_of_key ~value:snapshot_of_str
+    >>>= fun () ->
+    set ~dbg ~sr ~vdi:vdi_str ~key:_snapshot_time_key ~value:snapshot_time
+    >>>= fun () ->
+    set ~dbg ~sr ~vdi:vdi_str ~key:_is_a_snapshot_key ~value:(string_of_bool is_a_snapshot)
+
   let stat ~dbg ~sr ~vdi =
     (* TODO add default value to sharable? *)
     return_volume_rpc (fun () ->
@@ -1409,6 +1418,7 @@ module VDIImpl (M : META) = struct
   let vdi_destroy_impl dbg sr vdi' =
     (let vdi = Storage_interface.Vdi.string_of vdi' in
      Attached_SRs.find sr >>>= fun sr ->
+     (* TEMPORARY FIX: Commenting out stat to test if VDI already deleted by compose *)
      stat ~dbg ~sr ~vdi >>>= fun response ->
      (* Destroy any clone-on-boot volume that might exist *)
      ( match
@@ -1732,6 +1742,13 @@ module VDIImpl (M : META) = struct
     let* () = set ~dbg ~sr ~vdi ~key:_vdi_content_id_key ~value:content_id in
     return ()
 
+  let vdi_set_snapshot_metadata_impl dbg sr vdi snapshot_of snapshot_time is_a_snapshot =
+    wrap
+    @@
+    let* sr = Attached_SRs.find sr in
+    let* () = set_snapshot_metadata ~dbg ~sr ~vdi ~snapshot_of ~snapshot_time ~is_a_snapshot in
+    return ()
+
   let vdi_add_to_sm_config_impl dbg sr vdi key value =
     wrap
     @@
@@ -1950,6 +1967,7 @@ let bind ~volume_script_dir =
   S.VDI.data_destroy VDI.vdi_data_destroy_impl ;
   S.VDI.compose VDI.vdi_compose_impl ;
   S.VDI.set_content_id VDI.vdi_set_content_id_impl ;
+  S.VDI.set_snapshot_metadata VDI.vdi_set_snapshot_metadata_impl ;
   S.VDI.add_to_sm_config VDI.vdi_add_to_sm_config_impl ;
   S.VDI.remove_from_sm_config VDI.vdi_remove_from_sm_config_impl ;
   S.VDI.similar_content VDI.similar_content_impl ;
diff --git a/ocaml/xapi/storage_mux.ml b/ocaml/xapi/storage_mux.ml
index 0427f76ca..5accb4a9c 100644
--- a/ocaml/xapi/storage_mux.ml
+++ b/ocaml/xapi/storage_mux.ml
@@ -406,7 +406,19 @@ module Mux = struct
               set_snapshot_of __context ~dbg ~sr ~vdi:local_snapshot
                 ~snapshot_of:vdi ;
               set_is_a_snapshot __context ~dbg ~sr ~vdi:local_snapshot
-                ~is_a_snapshot:true
+                ~is_a_snapshot:true ;
+              (* Also update storage backend metadata so SR.scan doesn't overwrite
+                 with stale data from custom keys *)
+              let module C = StorageAPI (Idl.Exn.GenClient (struct
+                let rpc = of_sr sr
+              end)) in
+              (try
+                C.VDI.set_snapshot_metadata (Debug_info.to_string _di) sr local_snapshot 
+                  vdi src_snapshot_info.snapshot_time true
+              with e ->
+                debug "Failed to update snapshot metadata in storage backend for %s: %s"
+                  (s_of_vdi local_snapshot) (Printexc.to_string e)
+              )
             )
             snapshot_pairs
       )
@@ -698,6 +710,15 @@ module Mux = struct
       end)) in
       C.VDI.set_content_id (Debug_info.to_string di) sr vdi content_id
 
+    let set_snapshot_metadata () ~dbg ~sr ~vdi ~snapshot_of ~snapshot_time ~is_a_snapshot =
+      with_dbg ~name:"VDI.set_snapshot_metadata" ~dbg @@ fun di ->
+      info "VDI.set_snapshot_metadata dbg:%s sr:%s vdi:%s snapshot_of:%s" dbg
+        (s_of_sr sr) (s_of_vdi vdi) (s_of_vdi snapshot_of) ;
+      let module C = StorageAPI (Idl.Exn.GenClient (struct
+        let rpc = of_sr sr
+      end)) in
+      C.VDI.set_snapshot_metadata (Debug_info.to_string di) sr vdi snapshot_of snapshot_time is_a_snapshot
+
     let similar_content () ~dbg ~sr ~vdi =
       with_dbg ~name:"VDI.similar_content" ~dbg @@ fun di ->
       info "VDI.similar_content dbg:%s sr:%s vdi:%s" dbg (s_of_sr sr)
diff --git a/ocaml/xapi/storage_smapiv1.ml b/ocaml/xapi/storage_smapiv1.ml
index 0995edc35..4ad55b6d4 100644
--- a/ocaml/xapi/storage_smapiv1.ml
+++ b/ocaml/xapi/storage_smapiv1.ml
@@ -886,6 +886,10 @@ module SMAPIv1 : Server_impl = struct
             ~value:content_id
       )
 
+    let set_snapshot_metadata _context ~dbg:_ ~sr:_ ~vdi:_ ~snapshot_of:_ ~snapshot_time:_ ~is_a_snapshot:_ =
+      (* SMAPIv1 doesn't need this - snapshot metadata is managed by xapi database only *)
+      ()
+
     let similar_content _context ~dbg ~sr ~vdi =
       with_dbg ~name:"VDI.similar_content" ~dbg @@ fun di ->
       info "VDI.similar_content dbg:%s sr:%s vdi:%s" di.log (s_of_sr sr)
diff --git a/ocaml/xapi/storage_smapiv1_wrapper.ml b/ocaml/xapi/storage_smapiv1_wrapper.ml
index 86879780f..d8f4b9ca3 100644
--- a/ocaml/xapi/storage_smapiv1_wrapper.ml
+++ b/ocaml/xapi/storage_smapiv1_wrapper.ml
@@ -867,6 +867,13 @@ functor
         let dbg = Debug_info.to_string di in
         Impl.VDI.set_content_id context ~dbg ~sr ~vdi ~content_id
 
+      let set_snapshot_metadata context ~dbg ~sr ~vdi ~snapshot_of ~snapshot_time ~is_a_snapshot =
+        with_dbg ~name:"VDI.set_snapshot_metadata" ~dbg @@ fun di ->
+        info "VDI.set_snapshot_metadata dbg:%s sr:%s vdi:%s snapshot_of:%s" di.log
+          (s_of_sr sr) (s_of_vdi vdi) (s_of_vdi snapshot_of) ;
+        let dbg = Debug_info.to_string di in
+        Impl.VDI.set_snapshot_metadata context ~dbg ~sr ~vdi ~snapshot_of ~snapshot_time ~is_a_snapshot
+
       let similar_content context ~dbg ~sr ~vdi =
         with_dbg ~name:"VDI.similar_content" ~dbg @@ fun di ->
         info "VDI.similar_content dbg:%s sr:%s vdi:%s" di.log (s_of_sr sr)
